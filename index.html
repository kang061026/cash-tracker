<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>공금 잔액 관리</title>
  <style>
    :root{
      --bg:#0b0d12; --card:#121622; --muted:#9aa4b2; --text:#e6edf3; --line:#232a3a;
      --btn:#1f6feb; --btn2:#2dba4e; --danger:#e5534b;
      --pad:14px; --r:16px; --shadow: 0 10px 24px rgba(0,0,0,.35);
      --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Noto Sans KR", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      padding: calc(var(--pad) + var(--safe-top)) var(--pad) calc(110px + var(--safe-bottom)) var(--pad);
    }
    header{
      position: sticky; top:0; z-index:5;
      padding-top: calc(6px + var(--safe-top));
      margin: calc(-1 * (var(--pad) + var(--safe-top))) calc(-1 * var(--pad)) 10px calc(-1 * var(--pad));
      padding-left: var(--pad); padding-right: var(--pad);
      background: linear-gradient(180deg, rgba(11,13,18,1) 70%, rgba(11,13,18,0) 100%);
      backdrop-filter: blur(8px);
    }
    .row{ display:flex; gap:10px; }
    .card{
      background:var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card + .card{ margin-top: 12px; }
    .title{ font-size: 14px; color: var(--muted); margin:0 0 10px 0; }
    .big{ font-size: 28px; line-height: 1.1; margin: 2px 0 0 0; letter-spacing: -.3px; }
    .sub{ font-size: 13px; color: var(--muted); margin-top: 6px; }
    label{ display:block; font-size: 13px; color: var(--muted); margin: 10px 0 6px 0; }
    input, textarea{
      width:100%;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #0f1320;
      color: var(--text);
      padding: 12px 12px;
      font-size: 16px;
      outline:none;
    }
    textarea{ min-height: 74px; resize: vertical; }
    input[type="date"]{ padding: 10px 12px; }
    .btn{
      width:100%;
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 16px;
      color: white;
      background: var(--btn);
      cursor: pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.secondary{ background: #2b3245; }
    .btn.ok{ background: var(--btn2); }
    .btn.danger{ background: var(--danger); }
    .btn.inline{ width:auto; padding: 10px 12px; font-size: 14px; border-radius: 12px; }
    .btn:active{ transform: scale(.99); }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .hint{ font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.45; }
    .list{ display:flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .item{ border: 1px solid var(--line); border-radius: 14px; padding: 12px; background: #0f1320; }
    .itemTop{ display:flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .itemDate{ font-size: 14px; color: var(--muted); margin-bottom: 8px; }
    .itemNums{ display:flex; gap: 10px; flex-wrap: wrap; font-size: 15px; }
    .pill{ border: 1px solid var(--line); border-radius: 999px; padding: 6px 10px; background: rgba(255,255,255,.03); }
    .memo{ margin-top: 10px; font-size: 14px; color: #cbd5e1; white-space: pre-wrap; }
    .muted{ color: var(--muted); }
    .neg{ color: #ffb4a9; }
    .toolbar{ display:flex; gap: 8px; align-items: center; }
    .toggle{ display:flex; gap: 8px; margin-top: 10px; }
    .chip{
      flex:1; border: 1px solid var(--line); border-radius: 999px; padding: 10px 12px;
      font-size: 14px; background: #0f1320; color: var(--text);
      cursor:pointer; user-select:none; text-align:center; -webkit-tap-highlight-color: transparent;
    }
    .chip.active{ background: #1a2236; border-color: #31405f; }
    .bottomBar{
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 12px var(--pad) calc(12px + var(--safe-bottom)) var(--pad);
      background: rgba(11,13,18,.86);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
      z-index: 10;
    }
    .bottomRow{ display:flex; gap: 10px; }
    .bottomRow .btn{ flex: 1; }

    .modalBackdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display:none; align-items: center; justify-content: center; padding: 18px; z-index: 20;
    }
    .modal{
      width: 100%; max-width: 520px;
      background: var(--card); border: 1px solid var(--line);
      border-radius: 18px; padding: 14px; box-shadow: var(--shadow);
    }
    .modalHeader{ display:flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 10px; }
    .modalTitle{ font-size: 16px; color: var(--text); margin:0; }
    .closeX{
      border: 1px solid var(--line); background: #0f1320; color: var(--text);
      border-radius: 12px; padding: 8px 10px; font-size: 14px; cursor:pointer;
    }
  </style>
</head>
<body>
  <header>
    <div class="card" style="margin-top: 10px;">
      <div class="row" style="justify-content: space-between; align-items:flex-start;">
        <div style="flex:1;">
          <div class="title">남은 한화</div>
          <div class="big" id="remainKrw">-</div>
          <div class="sub" id="usedKrw">사용 합계: -</div>
        </div>
        <div style="width:10px;"></div>
        <div style="flex:1;">
          <div class="title">남은 엔화</div>
          <div class="big" id="remainJpy">-</div>
          <div class="sub" id="usedJpy">사용 합계: -</div>
        </div>
      </div>
      <div class="hint">시작 잔액을 입력한 뒤, 지출을 추가하면 자동으로 잔액이 계산된다.</div>
    </div>
  </header>

  <main>
    <section class="card" id="setupCard">
      <div class="row" style="justify-content: space-between; align-items:center;">
        <div class="title" style="margin:0;">시작 잔액 설정</div>
        <button class="btn inline secondary" id="toggleSetupBtn" type="button">접기</button>
      </div>

      <div id="setupBody" style="margin-top: 10px;">
        <div class="grid2">
          <div>
            <label for="startKrw">시작 한화 잔액</label>
            <input id="startKrw" inputmode="numeric" placeholder="예: 2400000" />
          </div>
          <div>
            <label for="startJpy">시작 엔화 잔액</label>
            <input id="startJpy" inputmode="numeric" placeholder="예: 50000" />
          </div>
        </div>

        <!-- 겹침 방지: 시작일과 버튼을 같은 줄로 두지 않고, 버튼은 단독 줄로 -->
        <div style="margin-top:10px;">
          <label for="startDate">시작일(선택)</label>
          <input id="startDate" type="date" />
        </div>

        <div style="margin-top:10px;">
          <button class="btn ok" id="saveSetupBtn" type="button">시작 잔액 저장</button>
        </div>

        <label style="margin-top:14px;">데이터 초기화(길게 누르기)</label>
        <button class="btn danger" id="resetBtn" type="button">전체 초기화</button>
        <div class="hint">실수 방지를 위해 1.2초 이상 길게 눌러야 초기화된다.</div>
      </div>
    </section>

    <section class="card">
      <div class="title">지출 입력</div>

      <!-- 빠른 입력 삭제 완료: 셀렉트 자체가 없음 -->
      <label for="entryDate">날짜</label>
      <input id="entryDate" type="date" />

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label for="spendJpy">엔화 지출</label>
          <input id="spendJpy" inputmode="numeric" placeholder="없으면 0" />
        </div>
        <div>
          <label for="spendKrw">한화 지출</label>
          <input id="spendKrw" inputmode="numeric" placeholder="없으면 0" />
        </div>
      </div>

      <label for="memo">메모(선택)</label>
      <textarea id="memo" placeholder="가게명, 품목 등"></textarea>

      <div style="margin-top: 10px;">
        <button class="btn" id="addEntryBtn" type="button">기록 추가</button>
      </div>

      <div class="hint">같은 날짜 기록을 여러 개 추가해도 된다.</div>
    </section>

    <section class="card">
      <div class="row" style="justify-content: space-between; align-items:center;">
        <div class="title" style="margin:0;">기록</div>
        <div class="toolbar">
          <button class="btn inline secondary" id="exportBtn" type="button">내보내기(텍스트)</button>
          <button class="btn inline secondary" id="importOpenBtn" type="button">가져오기</button>
        </div>
      </div>

      <div class="toggle">
        <div class="chip active" id="filterRecent">최근 7일</div>
        <div class="chip" id="filterAll">전체</div>
      </div>

      <div class="list" id="entryList"></div>
      <div class="hint muted" id="emptyHint" style="display:none;">아직 기록이 없다.</div>

      <input id="importFile" type="file" accept=".csv,text/csv,.txt,text/plain" style="display:none;" />
      <div class="hint">사파리에서 홈 화면에 추가하면 앱처럼 쓸 수 있다.</div>
    </section>
  </main>

  <div class="bottomBar">
    <div class="bottomRow">
      <button class="btn secondary" id="openSetupBtn" type="button">설정</button>
      <button class="btn ok" id="scrollTopBtn" type="button">맨 위</button>
    </div>
  </div>

  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <h3 class="modalTitle">기록 수정</h3>
        <button class="closeX" id="closeModalBtn" type="button">닫기</button>
      </div>

      <label for="editDate">날짜</label>
      <input id="editDate" type="date" />

      <div class="grid2">
        <div>
          <label for="editJpy">엔화 지출</label>
          <input id="editJpy" inputmode="numeric" />
        </div>
        <div>
          <label for="editKrw">한화 지출</label>
          <input id="editKrw" inputmode="numeric" />
        </div>
      </div>

      <label for="editMemo">메모</label>
      <textarea id="editMemo"></textarea>

      <div class="grid2" style="margin-top: 12px;">
        <button class="btn danger" id="deleteEntryBtn" type="button">삭제</button>
        <button class="btn ok" id="saveEditBtn" type="button">수정 저장</button>
      </div>

      <div class="hint muted" id="editInfo"></div>
    </div>
  </div>

  <script>
    const LS_KEY = "fx_cash_v2";

    function nowISODate(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function formatNumber(n){
      const sign = n < 0 ? "-" : "";
      const abs = Math.abs(Math.trunc(n));
      return sign + abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function parseIntSafe(v){
      if (v === null || v === undefined) return 0;
      const s = String(v).trim().replace(/,/g,"");
      if (!s) return 0;
      const n = Number(s);
      if (!Number.isFinite(n)) return 0;
      return Math.trunc(n);
    }
    function uid(){
      return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return { setup:{ startKrw:0, startJpy:0, startDate:"" }, entries:[], ui:{ filter:"recent", setupCollapsed:false } };
        const s = JSON.parse(raw);
        s.setup ||= { startKrw:0, startJpy:0, startDate:"" };
        s.entries ||= [];
        s.ui ||= { filter:"recent", setupCollapsed:false };
        return s;
      }catch(e){
        return { setup:{ startKrw:0, startJpy:0, startDate:"" }, entries:[], ui:{ filter:"recent", setupCollapsed:false } };
      }
    }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function totals(){
      const usedKrw = state.entries.reduce((a,e)=> a + (e.spendKrw||0), 0);
      const usedJpy = state.entries.reduce((a,e)=> a + (e.spendJpy||0), 0);
      const remainKrw = (state.setup.startKrw||0) - usedKrw;
      const remainJpy = (state.setup.startJpy||0) - usedJpy;
      return { usedKrw, usedJpy, remainKrw, remainJpy };
    }
    function isSetupDone(){
      return (state.setup.startKrw||0) !== 0 || (state.setup.startJpy||0) !== 0 || !!state.setup.startDate;
    }
    function clampDateRangeRecent7(dateStr){
      const today = new Date(); today.setHours(0,0,0,0);
      const d = new Date(dateStr + "T00:00:00");
      if (isNaN(d.getTime())) return false;
      const diffDays = Math.floor((today - d) / (1000*60*60*24));
      return diffDays >= 0 && diffDays <= 6;
    }
    function filteredEntries(){
      const arr = [...state.entries].sort((a,b)=>{
        if (a.date === b.date) return (b.createdAt||0) - (a.createdAt||0);
        return b.date.localeCompare(a.date);
      });
      if(state.ui.filter === "recent") return arr.filter(e => clampDateRangeRecent7(e.date));
      return arr;
    }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    const remainKrwEl = document.getElementById("remainKrw");
    const remainJpyEl = document.getElementById("remainJpy");
    const usedKrwEl = document.getElementById("usedKrw");
    const usedJpyEl = document.getElementById("usedJpy");

    const setupBody = document.getElementById("setupBody");
    const toggleSetupBtn = document.getElementById("toggleSetupBtn");
    const openSetupBtn = document.getElementById("openSetupBtn");

    const startKrwEl = document.getElementById("startKrw");
    const startJpyEl = document.getElementById("startJpy");
    const startDateEl = document.getElementById("startDate");
    const saveSetupBtn = document.getElementById("saveSetupBtn");

    const entryDateEl = document.getElementById("entryDate");
    const spendJpyEl = document.getElementById("spendJpy");
    const spendKrwEl = document.getElementById("spendKrw");
    const memoEl = document.getElementById("memo");
    const addEntryBtn = document.getElementById("addEntryBtn");

    const entryListEl = document.getElementById("entryList");
    const emptyHintEl = document.getElementById("emptyHint");

    const filterRecentEl = document.getElementById("filterRecent");
    const filterAllEl = document.getElementById("filterAll");

    const exportBtn = document.getElementById("exportBtn");
    const importOpenBtn = document.getElementById("importOpenBtn");
    const importFileEl = document.getElementById("importFile");

    const scrollTopBtn = document.getElementById("scrollTopBtn");
    const resetBtn = document.getElementById("resetBtn");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const editDateEl = document.getElementById("editDate");
    const editJpyEl = document.getElementById("editJpy");
    const editKrwEl = document.getElementById("editKrw");
    const editMemoEl = document.getElementById("editMemo");
    const saveEditBtn = document.getElementById("saveEditBtn");
    const deleteEntryBtn = document.getElementById("deleteEntryBtn");
    const editInfoEl = document.getElementById("editInfo");

    let state = loadState();
    let editingId = null;

    function renderSummary(){
      const t = totals();
      remainKrwEl.textContent = `${formatNumber(t.remainKrw)}원`;
      remainJpyEl.textContent = `${formatNumber(t.remainJpy)}엔`;
      usedKrwEl.textContent = `사용 합계: ${formatNumber(t.usedKrw)}원`;
      usedJpyEl.textContent = `사용 합계: ${formatNumber(t.usedJpy)}엔`;
      remainKrwEl.classList.toggle("neg", t.remainKrw < 0);
      remainJpyEl.classList.toggle("neg", t.remainJpy < 0);
    }
    function renderSetup(){
      startKrwEl.value = state.setup.startKrw ? String(state.setup.startKrw) : "";
      startJpyEl.value = state.setup.startJpy ? String(state.setup.startJpy) : "";
      startDateEl.value = state.setup.startDate || "";
      const collapsed = !!state.ui.setupCollapsed;
      setupBody.style.display = collapsed ? "none" : "block";
      toggleSetupBtn.textContent = collapsed ? "펼치기" : "접기";
    }
    function renderFilter(){
      const f = state.ui.filter || "recent";
      filterRecentEl.classList.toggle("active", f === "recent");
      filterAllEl.classList.toggle("active", f === "all");
    }

    function entryRowHtml(e){
      const jpy = e.spendJpy || 0;
      const krw = e.spendKrw || 0;
      const memo = (e.memo || "").trim();
      const memoHtml = memo ? `<div class="memo">${escapeHtml(memo)}</div>` : "";
      return `
        <div class="item" data-id="${e.id}">
          <div class="itemTop">
            <div style="flex:1;">
              <div class="itemDate">${escapeHtml(e.date || "")}</div>
              <div class="itemNums">
                <div class="pill">엔화: ${formatNumber(jpy)}엔</div>
                <div class="pill">한화: ${formatNumber(krw)}원</div>
              </div>
              ${memoHtml}
            </div>
            <div><button class="btn inline secondary editBtn" type="button">수정</button></div>
          </div>
        </div>
      `;
    }

    function renderEntries(){
      const items = filteredEntries();
      entryListEl.innerHTML = items.map(entryRowHtml).join("");
      emptyHintEl.style.display = items.length ? "none" : "block";
      entryListEl.querySelectorAll(".editBtn").forEach(btn=>{
        btn.addEventListener("click", (ev)=>{
          const item = ev.target.closest(".item");
          if(!item) return;
          openEdit(item.getAttribute("data-id"));
        });
      });
    }

    function normalizeAndValidateEntry(date, jpy, krw){
      const d = (date || "").trim();
      if(!d) return { ok:false, msg:"날짜가 비어 있다." };
      if(jpy < 0 || krw < 0) return { ok:false, msg:"지출은 음수일 수 없다." };
      if(jpy === 0 && krw === 0) return { ok:false, msg:"엔화/한화 지출이 모두 0이다." };
      if(jpy > 100000000 || krw > 2000000000) return { ok:false, msg:"입력 값이 너무 크다." };
      return { ok:true };
    }

    function addEntry(){
      if(!isSetupDone()){
        alert("먼저 시작 잔액을 저장해야 한다.");
        state.ui.setupCollapsed = false;
        saveState(); renderSetup();
        return;
      }
      const date = entryDateEl.value || nowISODate();
      const jpy = parseIntSafe(spendJpyEl.value);
      const krw = parseIntSafe(spendKrwEl.value);
      const memo = (memoEl.value || "").trim();
      const v = normalizeAndValidateEntry(date, jpy, krw);
      if(!v.ok){ alert(v.msg); return; }

      state.entries.push({ id: uid(), date, spendJpy:jpy, spendKrw:krw, memo, createdAt: Date.now() });
      saveState();

      spendJpyEl.value = ""; spendKrwEl.value = ""; memoEl.value = "";
      entryDateEl.value = date;
      renderAll();
    }

    function saveSetup(){
      const startKrw = parseIntSafe(startKrwEl.value);
      const startJpy = parseIntSafe(startJpyEl.value);
      const startDate = (startDateEl.value || "").trim();
      if(startKrw < 0 || startJpy < 0){ alert("시작 잔액은 음수일 수 없다."); return; }
      if(startKrw === 0 && startJpy === 0 && !startDate){ alert("시작 잔액 또는 시작일을 입력해야 한다."); return; }
      state.setup.startKrw = startKrw;
      state.setup.startJpy = startJpy;
      state.setup.startDate = startDate;
      saveState();
      renderAll();
      alert("저장됐다.");
    }

    function openEdit(id){
      const e = state.entries.find(x => x.id === id);
      if(!e) return;
      editingId = id;
      editDateEl.value = e.date || nowISODate();
      editJpyEl.value = String(e.spendJpy || 0);
      editKrwEl.value = String(e.spendKrw || 0);
      editMemoEl.value = e.memo || "";
      const created = e.createdAt ? new Date(e.createdAt) : null;
      editInfoEl.textContent = created ? `생성 시각: ${created.toLocaleString()}` : "";
      modalBackdrop.style.display = "flex";
    }
    function closeEdit(){ editingId = null; modalBackdrop.style.display = "none"; }
    function saveEdit(){
      if(!editingId) return;
      const idx = state.entries.findIndex(x => x.id === editingId);
      if(idx < 0) return;

      const date = editDateEl.value || nowISODate();
      const jpy = parseIntSafe(editJpyEl.value);
      const krw = parseIntSafe(editKrwEl.value);
      const memo = (editMemoEl.value || "").trim();

      const v = normalizeAndValidateEntry(date, jpy, krw);
      if(!v.ok){ alert(v.msg); return; }

      state.entries[idx] = { ...state.entries[idx], date, spendJpy:jpy, spendKrw:krw, memo };
      saveState();
      closeEdit();
      renderAll();
    }
    function deleteEntry(){
      if(!editingId) return;
      const ok = confirm("이 기록을 삭제할까?");
      if(!ok) return;
      state.entries = state.entries.filter(x => x.id !== editingId);
      saveState();
      closeEdit();
      renderAll();
    }

    // 텍스트 내보내기: 언제 / 얼마를 / 메모 / 남은 엔화 / 남은 한화
    function exportText(){
      const entries = [...state.entries].sort((a,b)=>{
        if (a.date === b.date) return (a.createdAt||0) - (b.createdAt||0);
        return a.date.localeCompare(b.date);
      });

      let usedKrw = 0, usedJpy = 0;
      let out = "";
      out += "공금 지출 기록\n";
      out += `시작 한화: ${formatNumber(state.setup.startKrw||0)}원\n`;
      out += `시작 엔화: ${formatNumber(state.setup.startJpy||0)}엔\n`;
      if(state.setup.startDate) out += `시작일: ${state.setup.startDate}\n`;
      out += "\n";

      entries.forEach(e=>{
        usedKrw += (e.spendKrw||0);
        usedJpy += (e.spendJpy||0);
        const remainKrw = (state.setup.startKrw||0) - usedKrw;
        const remainJpy = (state.setup.startJpy||0) - usedJpy;

        const when = e.date || "";
        const amountParts = [];
        if((e.spendJpy||0) !== 0) amountParts.push(`엔화 ${formatNumber(e.spendJpy)}엔`);
        if((e.spendKrw||0) !== 0) amountParts.push(`한화 ${formatNumber(e.spendKrw)}원`);
        const amount = amountParts.join(", ") || "0";

        out += `언제: ${when}\n`;
        out += `얼마를: ${amount}\n`;
        out += `메모: ${(e.memo||"").trim() || "-"}\n`;
        out += `남은 엔화: ${formatNumber(remainJpy)}엔\n`;
        out += `남은 한화: ${formatNumber(remainKrw)}원\n`;
        out += "\n";
      });

      const blob = new Blob([out], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `공금기록_${nowISODate()}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // 가져오기(기존 CSV 가져오기 유지: 필요 없으면 나중에 빼도 됨)
    function openImport(){
      importFileEl.value = "";
      importFileEl.click();
    }
    function parseSetupFromText(text){
      const lines = text.split(/\r?\n/);
      const setup = { startKrw: 0, startJpy: 0, startDate: "" };
      let inSetup = false;
      for(const line of lines){
        if(line.trim() === "#SETUP"){ inSetup = true; continue; }
        if(line.trim() === "#ENTRIES"){ break; }
        if(!inSetup) continue;
        const m = line.match(/^(\w+)\s*=\s*(.*)$/);
        if(!m) continue;
        const key = m[1]; const val = m[2];
        if(key === "startKrw") setup.startKrw = parseIntSafe(val);
        if(key === "startJpy") setup.startJpy = parseIntSafe(val);
        if(key === "startDate") setup.startDate = (val||"").trim();
      }
      return setup;
    }
    function parseCsvLine(line){
      const out = [];
      let cur = ""; let inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(inQ){
          if(ch === '"'){
            if(line[i+1] === '"'){ cur += '"'; i++; }
            else inQ = false;
          }else cur += ch;
        }else{
          if(ch === '"') inQ = true;
          else if(ch === ','){ out.push(cur); cur = ""; }
          else cur += ch;
        }
      }
      out.push(cur);
      return out;
    }
    function importCSVFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const text = String(reader.result || "");
          const setup = parseSetupFromText(text);

          const idx = text.indexOf("#ENTRIES");
          const csvPart = idx >= 0 ? text.slice(idx) : text;
          const lines = csvPart.split(/\r?\n/).filter(l => l.trim().length > 0);
          const headerIdx = lines.findIndex(l => l.includes("id,") && l.includes(",date,"));
          if(headerIdx < 0){ alert("가져오기 실패: 형식이 올바르지 않다."); return; }

          const header = lines[headerIdx].split(",");
          const dataLines = lines.slice(headerIdx + 1);
          const entries = [];
          for(const line of dataLines){
            const row = parseCsvLine(line);
            if(row.length < 4) continue;
            const obj = {};
            header.forEach((h,i)=> obj[h] = row[i] ?? "");
            entries.push({
              id: (obj.id || uid()).trim(),
              date: (obj.date || "").trim(),
              spendJpy: parseIntSafe(obj.spendJpy),
              spendKrw: parseIntSafe(obj.spendKrw),
              memo: (obj.memo || "").trim(),
              createdAt: parseIntSafe(obj.createdAt) || Date.now()
            });
          }

          const ok = confirm("가져오기 하면 현재 데이터가 덮어쓰기 된다. 진행할까?");
          if(!ok) return;
          state.setup = setup;
          state.entries = entries;
          saveState();
          renderAll();
          alert("가져오기 완료.");
        }catch(e){
          alert("가져오기 실패: 파일을 읽을 수 없다.");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    // 길게 눌러 초기화
    let pressTimer = null;
    function setupLongPressReset(){
      const start = () => {
        pressTimer = setTimeout(()=>{
          pressTimer = null;
          const ok = confirm("전체 초기화할까? 시작 잔액과 기록이 모두 삭제된다.");
          if(!ok) return;
          localStorage.removeItem(LS_KEY);
          state = loadState();
          renderAll();
          alert("초기화 완료.");
        }, 1200);
      };
      const cancel = () => { if(pressTimer){ clearTimeout(pressTimer); pressTimer = null; } };
      resetBtn.addEventListener("touchstart", start, {passive:true});
      resetBtn.addEventListener("touchend", cancel);
      resetBtn.addEventListener("touchcancel", cancel);
      resetBtn.addEventListener("mousedown", start);
      resetBtn.addEventListener("mouseup", cancel);
      resetBtn.addEventListener("mouseleave", cancel);
    }

    function renderAll(){
      renderSummary();
      renderSetup();
      renderFilter();
      renderEntries();
    }

    toggleSetupBtn.addEventListener("click", ()=>{
      state.ui.setupCollapsed = !state.ui.setupCollapsed;
      saveState();
      renderSetup();
    });
    openSetupBtn.addEventListener("click", ()=>{
      state.ui.setupCollapsed = false;
      saveState();
      renderSetup();
      window.scrollTo({top:0, behavior:"smooth"});
    });
    saveSetupBtn.addEventListener("click", saveSetup);
    addEntryBtn.addEventListener("click", addEntry);

    filterRecentEl.addEventListener("click", ()=>{
      state.ui.filter = "recent";
      saveState();
      renderFilter();
      renderEntries();
    });
    filterAllEl.addEventListener("click", ()=>{
      state.ui.filter = "all";
      saveState();
      renderFilter();
      renderEntries();
    });

    exportBtn.addEventListener("click", exportText);
    importOpenBtn.addEventListener("click", openImport);
    importFileEl.addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      importCSVFile(file);
    });

    scrollTopBtn.addEventListener("click", ()=> window.scrollTo({top:0, behavior:"smooth"}) );

    closeModalBtn.addEventListener("click", closeEdit);
    modalBackdrop.addEventListener("click", (e)=>{ if(e.target === modalBackdrop) closeEdit(); });
    saveEditBtn.addEventListener("click", saveEdit);
    deleteEntryBtn.addEventListener("click", deleteEntry);

    entryDateEl.value = nowISODate();
    setupLongPressReset();
    renderAll();
    if(!isSetupDone()){
      state.ui.setupCollapsed = false;
      saveState();
      renderSetup();
    }
  </script>
</body>
</html>
